$def with (ctx)
$ kerusakan = ctx.get('kerusakan')
$ pos = ctx.get('pos')
$ tg = ctx.get('tgl')
$code:
    haris = [h.title() for h in "sen_sel_rab_kam_jum_sab_min".split('_')]
    bulan = [b.title() for b in "jan_feb_mar_apr_mei_jun_jul_ags_sep_okt_nop_des".split('_')]
$var extra_header:
<style type="text/css">
  .card-img-top {
    width: 100%;
    border-top-left-radius: calc(.25rem - 1px);
    border-top-right-radius: calc(.25rem - 1px);
  }
  .card {
    position: relative;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-orient: vertical;
    -webkit-box-direction: normal;
    -ms-flex-direction: column;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: border-box;
/*    border: 1px solid rgba(255, 0, 0, 0.8);*/
    border-radius: .25rem;
  }
  .card-body {
    -webkit-box-flex: 1;
    -ms-flex: 1 1 auto;
    flex: 1 1 auto;
    padding: 1.25rem;
  }
  .card-text:last-child {
    margin: 10.5px;
  }
  .card-footer {
    padding: .75rem 1.25rem;
    background-color: rgba(0,0,0,.03);
/*    border-top: 1px solid rgba(255, 0, 0, 0.8);*/
  }
  p {
    margin: 1rem;
  }
  .card-header {
    padding: .75rem 1.25rem;
    margin-bottom: 0;
/*    background-color: rgba(0,0,0,.03);
    border-bottom: 1px solid rgba(255, 0, 0, 0.8);*/
  }
  .img-fluid {
    max-width: 100%;
    height: auto;
  }
  .tanggapan, input {
    border-width: 2px;
    -webkit-box-shadow: none;
    box-shadow: none;
  }
  .tanggapan {
    width: 60%;
    height: 45px;
    padding: 10px 15px;
    background-color: #fff;
    border: 1px solid #dce4ec;
    border-radius: 4px;
    -webkit-transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
    -o-transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
    transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
  }
  .tanggapan, output {
    display: block;
    font-size: 15px;
    line-height: 1.42857143;
    color: #2c3e50;
  }

}
</style>
$var js_foot:
    <script src="/static/js/MinifyJpegAsync.js"></script>
    <script>
          \$(document).ready(function () {
            \$('select[name="kegiatan"]').change(function () {
              if (\$('input#fotoFile')[0].files && (\$('input#fotoFile')[0].files.length > 0)) {
                \$('input[name="submit"]').removeClass('disabled');
              }
              console.log(this.value);
            });
            \$('#fotoFile').change(function (event){ readURL(event); });
          });
          let enc_img = '';
          let file_name = '';
          function readURL(event) {
            let f = event.target.files[0];
            file_name = f.name;
            let reader = new FileReader();

            reader.onloadend = (function(theFile){
              return function(e) {
                MinifyJpegAsync.minify(e.target.result, 1280, function(data) { 
                  enc_img = "data:image/jpeg;base64," + btoa(data);
                  let img = new Image();
                  img.src = enc_img;
                  document.getElementById('blah').src = enc_img;
                  //\$.post('/adm/bendungan/bd_krisak/kegiatan', {data: enc_img, filename: f.name})
                  console.log('Hasil proses minify') 
                });
              };
            })(f);
            reader.readAsDataURL(f);
          };

          function go_upload() {
            if(\$('#blah').attr('src') == '#'){
              alert('pilih foto dulu');
            }else{
              var kerusakan_id = \$('#k_id').val();
              var deskripsi_foto = \$('#deskripsi-foto').val();
              \$.post('/adm/bendungan/$pos.table_name/kerusakan', {state:'tambah_foto',kerusakan_id: kerusakan_id,deskripsi_foto: deskripsi_foto,data: enc_img, filename: file_name}).done(function(result){
                //alert(result);
                var a = result;
                if(a == "ok"){
                  window.location.href = "/adm/bendungan/$pos.table_name/kerusakan";
                }
              });
            }
          
          }

    </script>
<!-- End -->
<h1>Kerusakan Asset Pada $pos.cname</h1>

<div>
  <div class="row">
    $for k in kerusakan:
    <div class="col-md-6" style="margin-bottom: 2rem;">
        $if k.kategori == 'berat':
            <div class="card" style="border: 1px solid red">
        $elif k.kategori == 'sedang':
            <div class="card" style="border: 1px solid yellow">
        $elif k.kategori == 'ringan':
            <div class="card" style="border: 1px solid green">

        <div class="card-header bg-transparent border-success text-center">  
          <strong><span class="text-muted">$k.asset.nama</span></strong>
        </div>

        <div class="card-body">
          <div>
            <p class="card-text" style="font-size: 0.8em;">Uraian Kerusakan :</p>
          </div>
          <p class="card-text" style="font-size: 1.5em;">$k.uraian</p>
          <p class="card-text text-muted" style="font-size: 0.8em;margin-left: 1.5em;">$k.cuser, $k.cdate</p>
          $if not session.table_name:
              <div style="margin-left: 18px;">
                <form class="form-inline">
                  $if len(k.get(k.id).tanggapan1)==0:
                       <input type="hidden" id="kerusakan_id_$k.id" name="kerusakan_id_$k.id" value="$k.id">
                       <div class="form-group">
                         <input type="text" class="form-control" id="uraian-tanggapan1_$k.id" placeholder="Tanggapan Anda..">
                       </div>
                       <div class="form-group">
                         <select class="form-control" id="kategori" required="">
                          <option value="">Kategori</option>
                          <option value="ringan">Ringan</option>
                          <option value="sedang">Sedang</option>
                          <option value="berat">Berat</option>
                        </select>
                       </div>
                       <div class="form-group">
                         <select class="form-control" id="lanjut" required="">
                          <option value="">Lanjut</option>
                          <option value="1">Ya</option>
                          <option value="0">Tidak</option>
                        </select>
                       </div>
                       $if session.is_admin == 3:
                          <button type="button" onclick="tanggapan1($k.id,0)" class="btn btn-primary">Kirim</button>
                       $elif session.is_admin == 4:
                          <button type="button" onclick="alert('selamat ali')" class="btn btn-success">Kirim</button>
                  $else:
                      <input type="hidden" id="kerusakan_id_$k.id" name="kerusakan_id_$k.id" value="$k.id">
                       <div class="form-group">
                         <input type="text" class="form-control" id="uraian-tanggapan1_$k.id" placeholder="Tanggapan Anda..">
                       </div>
                       $if session.is_admin == 3:
                          <button type="button" onclick="tanggapan1($k.id,1)" class="btn btn-primary">Kirim</button>
                       $elif session.is_admin == 4:
                          <button type="button" onclick="alert('selamat ali')" class="btn btn-success">Kirim</button>
                </form>
              </div>
          <br>
          $for t1 in k.get(k.id).tanggapan1:
              <div style="margin-left: 1em;">
                <p class="card-text" style="font-size: 0.8em;font-style: italic;">Tanggapan UPB :</p>
                <p class="card-text" style="font-size: 1em;">$t1.uraian</p>
                <p class="card-text text-muted" style="font-size: 0.8em;margin-left: 1.5em">$t1.cuser, $t1.cdate</p>
              </div>
        </div>

        <div class="card-footer">
          $for f in k.get(k.id).foto:
              <a href="#" onclick="fotomodal($f.id,'$f.keterangan')"><img class="img-thumbnail" src="${'/'+f.filepath}" id="foto_kers_$f.id" alt="Card image cap" style="width: 6rem;height: 6rem;"></a>
          $if session.table_name:
              <button class="btn-outline-primary btn-sm" onclick="tambahfoto($k.id)"><span class="glyphicon glyphicon-plus"></span></button>
        </div>

      </div>
    </div>
  </div>

<!--   <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Detail Kerusakan Asset <span id="asset"></span></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form action="/adm/bendungan/tanggapan1" method="post">
          <input type="hidden" id="kerusakan_id" name="kerusakan_id">
          <div class="form-group">
            <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
              <div class="carousel-inner">
                <div class="carousel-item">
                  <img class="img-fluid" src="">
                </div>
              </div>
              <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
              </a>
              <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
              </a>
            </div>
          </div>
          <div class="form-group">
            <label class="col-form-label">Deskripsi Foto:</label>
            <textarea rows="3" cols="25" class="form-control" disabled="" value="" id="deskripsi"></textarea>
          </div>
          <div class="form-group">
            <label class="col-form-label">Waktu Lapor:</label>
            <input type="text" class="form-control" disabled="" value="" id="waktu">
          </div>
          <div class="form-group">
            <label class="col-form-label">Lokasi:</label>
            <input type="text" class="form-control" disabled="" value="" id="lokasi">
          </div>
          <fieldset class="form-group">
            <div class="row">
              <label class="col-form-label col-sm-2">Kategori Menurut UPB:</label>
              <div class="col-sm-10">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="kategori" id="kategori_ringan" value="ringan" required>
                  <label class="form-check-label">
                    Ringan (Level kerusakan 10%-20%)
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="kategori" id="kategori_sedang" value="sedang" required>
                  <label class="form-check-label">
                    Sedang (Level kerusakan 21%-40%)
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="kategori" id="kategori_berat" value="berat" required>
                  <label class="form-check-label">
                    Berat (Level kerusakan diatas 40%)
                  </label>
                </div>
              </div>
            </div>
          </fieldset>
          <div class="form-group">
            <label class="col-form-label">Uraian Tanggapan:</label>
            <textarea rows="3" cols="25" class="form-control" id="uraian-tanggapan1" required=""></textarea>
          </div>
          <fieldset class="form-group">
            <div class="row">
              <label class="col-form-label col-sm-2">Lanjutkan Laporan Kerusakan ?</label>
              <div class="col-sm-10">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="lanjut" id="lanjut_ya" value="1" required>
                  <label class="form-check-label">
                    Ya
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="lanjut" id="lanjut_tidak" value="0" required>
                  <label class="form-check-label">
                    Tidak
                  </label>
                </div>
              </div>
            </div>
          </fieldset>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        $if not session.table_name:
            $if session.is_admin == 3:
                <button type="button" class="btn btn-primary" onclick="tanggapan1()">Kirim</button>
            $elif session.is_admin == 4:
                <button type="button" class="btn btn-success" onclick="tanggapan2()">Kirim</button>
      </div>
    </div>
  </div>
</div> -->


  <div class="modal fade" id="fotomodal" tabindex="-1" role="dialog" aria-labelledby="fotomodalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-center">Foto Kerusakan Asset</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <img class="img-fluid" src="" id="foto-modal-show">
            <div style="position: absolute;top: 70%;left: 0;width: 100%;background-color: rgba(255, 255, 255, 0.6);">
                <p class="text-center" id="f_keterangan"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="tambahfotomodal" tabindex="-1" role="dialog" aria-labelledby="tambahfotomodalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-center">Tambah Foto Kerusakan</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
        <input type="file" name="foto" class="custom-file-input" id="fotoFile">
          <form method="POST" id="formUpload" enctype="multipart/form-data">
            <input type="hidden" id="k_id" name="k_id">
            <div class="form-group">
              <div class="custom-file">
                <img id="blah" class="img-fluid" style="width: 100%;" alt=" pratinjau gambar" src="#">
              </div>
              <div v-if="imageData.length > 0"><img class="img-fluid" :src="imageData"></div>
            </div>

            <div class="form-group row">
              <label class="col-sm-2 col-form-label">Deskripsi Foto</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" id="deskripsi-foto" name="deskripsi-foto" required="">
              </div>
            </div>

            <div class="form-group row">
              <div class="col-sm-10">
                <input type="button" name="submit" value="Kirim" onclick="go_upload()" class="btn btn-primary btn-sm">
                <button class="btn btn-danger btn-sm" type="button" data-dismiss="modal" onclick="srcnull()">Batal</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


</div>
</div>

<script type="text/javascript">
  function modal(a,b,c,d,e){
    var a = a;
    var b = b;
    var c = c;
    var d = d;
    var e = e;
    \$('#exampleModal').modal('show');
    \$('#asset').html(a);
    \$('#kid_slide').html(e);
    // \$('#foto-kerusakan-tanggapan').attr('src','/'+b);
    \$('#deskripsi').val(b);
    \$('#waktu').val(c);
    \$('#lokasi').val(d);
    \$('#kerusakan_id').attr('value',e);
  }

  function fotomodal(fid,fket){
    //var a = \$('#foto').attr('src');
    var a = \$('#foto_kers_'+fid).attr('src');
    \$('#fotomodal').modal('show');
    \$('#foto-modal-show').attr('src',a);
    \$('#f_keterangan').html(fket);
  }

  function tambahfoto(kid){
    \$('#tambahfotomodal').modal('show');
    \$('#k_id').attr('value',kid);
  }

  function srcnull(){
    \$('#fotoFile').val('');
    \$('#blah').attr('src','#');
  }

  function tanggapan1(kid,state){
    if(state == 0){
      var kerusakan_id = \$("#kerusakan_id_"+kid).val();
      var uraian = \$("#uraian-tanggapan1_"+kid).val();
      var kategori = \$( "select#kategori" ).val();
      var lanjut = \$( "select#lanjut" ).val();
      if(uraian == ""){
        alert("uraian tanggapan harap di isi..");
        \$( "#uraian-tanggapan1_"+kid ).focus();
      }else if(kategori == ""){
        alert("kategori harap di isi..");
        \$( "#kategori" ).focus();
      }else if(lanjut == ""){
        alert("kelanjutan laporan harap di isi..");
        \$( "#lanjut" ).focus();
      }else{
        \$.post('/adm/bendungan//tanggapan1', {kerusakan_id:kerusakan_id,kategori:kategori,lanjut:lanjut,uraian:uraian,state:'0'}).done(function(result){
          var a = result;
          if(a == "ok"){
            alert("Data Berhasil Disimpan");
            window.location.reload();
          }
        });
      }
    }else if(state == 1){
      var kerusakan_id = \$("#kerusakan_id_"+kid).val();
      var uraian = \$("#uraian-tanggapan1_"+kid).val();
      if(uraian == ""){
        alert("uraian tanggapan harap di isi..");
        \$( "#uraian-tanggapan1_"+kid ).focus();
      }else{
        \$.post('/adm/bendungan//tanggapan1', {kerusakan_id:kerusakan_id,uraian:uraian,state:'1'}).done(function(result){
          var a = result;
          if(a == "ok"){
            alert("Data Berhasil Disimpan");
            window.location.reload();
          }
        });
      }
    }
    

  }

  function tanggapan1_1(kid){
    var kerusakan_id = \$("#kerusakan_id_"+kid).val();
    var uraian = \$("#uraian-tanggapan1_"+kid).val();
    if(uraian == ""){
      alert("uraian tanggapan harap di isi..");
      \$( "#uraian-tanggapan1_"+kid ).focus();
    }else{
      \$.post('/adm/bendungan//tanggapan1', {kerusakan_id:kerusakan_id,uraian:uraian,state:'1'}).done(function(result){
        var a = result;
        if(a == "ok"){
          alert("Data Berhasil Disimpan");
          window.location.reload();
        }
      });
    }

  }
</script>
